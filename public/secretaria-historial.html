<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Secretar√≠a ¬∑ Historia Cl√≠nica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>

  <!-- Firebase + app -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script defer src="./common.js"></script>
  <script defer src="./secretaria-historial.js"></script>

  <!-- Ajustes m√≠nimos de layout para esta pantalla -->
  <style>
    .inline { display:flex; gap:8px; align-items:center; }
    .inline > * { flex: 0 0 auto; }
    .inline .grow { flex: 1 1 auto; }

    .divider {
      height: 1px;
      background: var(--border, #2a2a2a);
      opacity: .25;
      margin: 12px 0;
    }

    .actions.centered{
      margin-top:12px; display:flex; gap:12px;
      justify-content:center; align-items:center; flex-wrap:wrap;
    }
    .actions.centered .btn{ min-width:150px; }

    .subtitle { margin: 6px 0; }
    .subtitle.center { text-align:center; }

    .span-2 { grid-column: 1 / -1; }
    .subcard {
      border: 1px solid var(--border, #2a2a2a);
      border-radius: 12px;
      padding: 12px;
    }
    .muted { color:#666; font-size:.9rem; }

    /* T√≠tulo centrado + bot√≥n a la derecha (para "Visitas registradas") */
    .header-with-action { position: relative; }
    .header-with-action h3 { margin:0; text-align:center; }
    .header-with-action .action-right { position:absolute; right:0; top:0; }
  </style>
</head>
<body>
<header class="topbar">
  <div class="logo">ü¶∑ <span>DENTASOFT</span></div>
  <nav class="menu">
    <a class="backlink upper" href="./secretaria.html">ATR√ÅS</a>
  </nav>
</header>

<section class="container">
  <div class="page-head"><h1 class="headline-xl">Historia Cl√≠nica</h1></div>

  <!-- === CUADRO 1: Buscar + Datos paciente + Agregar visita (todo junto) === -->
  <div class="card" id="cardPrincipal">
    <!-- 1) Ingresar DNI -->
    <h3 class="subtitle">Ingresar DNI del paciente</h3>
    <div class="inline">
      <input id="hDni" class="grow" inputmode="numeric" maxlength="8" placeholder="Ingres√° el DNI del paciente">
      <button id="hBuscar" class="btn btn-primary">Buscar</button>
    </div>

    <!-- (quitamos la 1¬™ l√≠nea para que no queden dos: ahora solo habr√° una l√≠nea m√°s abajo) -->

    <!-- 2) Datos del paciente -->
    <div id="pacientePreview" class="subcard" style="display:none; margin-top:12px;">
      <div class="headline-s" style="margin-bottom:6px;">Paciente</div>
      <div class="grid-2">
        <div><strong>Nombre:</strong> <span id="pNombre"></span></div>
        <div><strong>Apellido:</strong> <span id="pApellido"></span></div>
        <div><strong>Email:</strong> <span id="pEmail"></span></div>
        <div><strong>Tel√©fono:</strong> <span id="pTelefono"></span></div>
        <div class="span-2"><strong>Obra Social:</strong> <span id="pObra"></span></div>
      </div>
    </div>

    <div class="divider"></div> <!-- dejamos solo ESTA l√≠nea como separador √∫nico -->

    <!-- 3) Agregar nueva visita -->
    <h3 class="subtitle center">Agregar nueva visita</h3>
    <form id="formHist">
      <div class="grid-2">
        <!-- Fecha de la visita (nuevo) -->
        <label class="span-2">Fecha de la visita
          <input type="datetime-local" id="fechaVisita" name="fechaVisita">
        </label>

        <!-- Odont√≥logo -->
        <label>Odont√≥logo
          <select id="selOdo" name="odontologoUid" required>
            <option value="">Cargando‚Ä¶</option>
          </select>
        </label>

        <!-- Motivo -->
        <label>Motivo
          <select name="motivo" required>
            <option value="" disabled selected>Seleccionar‚Ä¶</option>
            <option>Limpieza</option>
            <option>Extracci√≥n</option>
            <option>Obturaci√≥n (caries)</option>
            <option>Endodoncia</option>
            <option>Control</option>
          </select>
        </label>

        <!-- Estado administrativo -->
        <label>Estado
          <select name="estadoTurno" required>
            <option>programado</option>
            <option>completado</option>
            <option>cancelado</option>
            <option>pospuesto</option>
          </select>
        </label>

        <!-- Pagado -->
        <label>Pagado
          <select name="pagado">
            <option value="true">S√≠</option>
            <option value="false">No</option>
          </select>
        </label>

        <!-- Notas -->
        <label class="span-2">Notas de la visita
          <textarea name="descripcion" id="notas" rows="3" maxlength="500" placeholder="Observaciones administrativas (no cl√≠nicas)‚Ä¶"></textarea>
        </label>
      </div>

      <!-- Acciones que afectan a TODO (incluye DNI y datos) -->
      <div class="actions centered">
        <button type="submit" class="btn btn-primary">Guardar Visita</button>
        <button type="button" id="btnCancelar" class="btn">Cancelar</button>
      </div>
    </form>

    <!-- Mensajes -->
    <div id="status" class="notice" style="display:none; margin-top:10px;"></div>
  </div>

  <!-- === CUADRO 2: Visitas registradas === -->
  <div class="card">
    <div class="header-with-action">
      <h3 class="subtitle center">Visitas registradas</h3>
      <button id="btnToggleVisitas" class="btn action-right" disabled>Ver visitas</button>
    </div>

    <div id="visitasWrap" class="subcard" style="display:none; margin-top:8px;">
      <ul id="hLista" style="margin:0; padding-left:18px;"></ul>

      <!-- Botones del historial (abajo y centrados) -->
      <div class="actions centered" style="margin-top:12px;">
        <button id="btnPrintVisitas" class="btn" disabled>Imprimir</button>
        <button id="btnCerrarVisitas" class="btn">Cancelar</button>
      </div>
    </div>

    <div class="muted" id="visitasHint" style="margin-top:6px;">Busc√° un paciente para habilitar este panel.</div>
  </div>
</section>
</body>
</html>
